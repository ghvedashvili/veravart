<!DOCTYPE html>
<html lang="ka">
<head>
  <meta charset="UTF-8">
  <title>პენალტების სერია</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  
  <!-- PWA Meta Tags for iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="პენალტები">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚽</text></svg>">
  
  <!-- Prevent zoom and touch callouts -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <style>
    /* iOS Optimized Styles */
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
      background: #2a2a2a;
      height: 100vh;
      height: -webkit-fill-available;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }

    /* Safe Area Support for iPhone Notch */
    .game-container {
      min-height: 100vh;
      min-height: -webkit-fill-available;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    /* Prevent elastic scrolling */
    body {
      overscroll-behavior: none;
      position: fixed;
      width: 100%;
      height: 100%;
    }

    /* Your existing styles with iOS improvements */
    h1 {
      font-size: 10vw;
      margin: 0;
      position: absolute;
      font-weight: 900;
      color: gold;
      text-shadow: 3px 3px black;
      left: 50%;
      top: 25%;
      transform: translate(-50%, -50%);
      opacity: 0;
      pointer-events: none;
      user-select: none;
      z-index: 10;
    }

    .show_result {
      transition: 0.75s;
      transition-delay: 1s;
      opacity: 1;
    }

    .game-container {
      background: url(img/image5.png);
      background-repeat: no-repeat;
      background-size: 115%;
      background-position: top center;
      background-color: #000;
    }

    #game_field {
      width: 100%;
      height: calc(100vh - 100px);
      height: calc(100dvh - 100px);
      position: relative;
      margin: 0 auto;
      overflow: hidden;
      top: 100px;
    }

    /* Rest of your existing CSS remains the same */
    #goal {
      width: 80vw;
      max-width: 500px;
      aspect-ratio: 2 / 1;
      background: url('https://contentservice.mc.reyrey.net/image_v1.0.0/?id=f4278541-20df-568f-baea-e387ee22937c&638600307412335028') center center / cover no-repeat;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 5vh;
      animation: shake 0.25s linear infinite;
      transition: all 0.3s ease;
    }

    @keyframes shake {
      25% { transform: translateX(-50%) rotate(1deg); }
      75% { transform: translateX(-50%) rotate(-1deg); }
    }

    .hitbox {
      position: absolute;
      background-color: red;
      border-radius: 50%;
      opacity: 0.5;
      transition: all 0.3s ease;
      pointer-events: auto;
      -webkit-tap-highlight-color: transparent;
    }

    .hitbox.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .hitbox.green {
      background-color: #4CAF50;
      opacity: 0.5;
    }

    .hitbox[box="0"], .hitbox[box="4"] {
      width: 15%;
      height: 30%;
      bottom: 0;
    }

    .hitbox[box="0"] { left: 0; }
    .hitbox[box="1"] { left: 0; top: 0; width: 15%; height: 30%; }
    .hitbox[box="2"] { left: 40%; top: 0; width: 15%; height: 30%; }
    .hitbox[box="3"] { right: 0; top: 0; width: 15%; height: 30%; }
    .hitbox[box="4"] { right: 0; }

    #ball {
      width: 8vw;
      max-width: 40px;
      aspect-ratio: 1 / 1;
      background-size: cover;
      position: absolute;
      left: 50%;
      top: 85%;
      transform: translate(-50%, -50%);
      z-index: 5;
      pointer-events: none;
      transition: left 0.8s ease-out, top 0.8s ease-out;
    }

    #ball:after {
      content: '';
      display: block;
      width: 100%;
      height: 100%;
      background: url('http://upload.wikimedia.org/wikipedia/en/e/ec/Soccer_ball.svg') center center / contain no-repeat;
      border-radius: 50%;
      animation: none;
    }

    .kicked:after { animation: roll 1s linear infinite; }

    @keyframes roll {
      100% { transform: rotate(1080deg); }
    }

    .goal { 
      animation: score 0.5s linear 0.5s forwards;
      transition: none !important;
    }
    .fall { 
      animation: fall 0.5s linear 0.5s forwards;
      transition: none !important;
    }

    @keyframes score { to { top: 40%; } }
    @keyframes fall { to { top: 40%; } }

    svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    /* Your existing styles continue... */
  </style>
</head>
<body>
  <div class="container-fluid game-container">
    <div class="row">
      <div class="col-12">
        <div id="total-score" class="total-score">საერთო ანგარიში: მოთამაშე 0 - 0 Kidsmart</div>
        <div class="scoreboard">
          <div id="player-score">მოთამაშე 0:</div>
          <div id="computer-score">0 Kidsmart</div>
        </div>
        <div id="turn-indicator" class="turn-indicator">თქვენი პენალტი</div>
        
        <div id="penalty-count" class="penalty-count">პენალტი 1/5</div>
        
        <div id="game_field">
          <div id="goal">
            <div class="hitbox" box="0"></div>
            <div class="hitbox" box="1"></div>
            <div class="hitbox" box="2"></div>
            <div class="hitbox" box="3"></div>
            <div class="hitbox" box="4"></div>
          </div>

          <div id="ball"></div>

          <svg id="svg" viewBox="0 0 100 100">
            <path id="path" d="" stroke="transparent" fill="transparent" />
            <circle id="circle" r="5" fill="rgba(255,0,0,0)">
              <animateMotion id="bally" dur="1s" repeatCount="1" fill="freeze" />
            </circle>
          </svg>

          <h1 id="success">GOAL!</h1>
          <h1 id="failure" style="color: red;">FAIL</h1>
        </div>
      </div>
    </div>
  </div>

  <div id="game-over" class="game-over" style="display: none;">
    <h2 id="result-message">გამარჯვებული!</h2>
    <div id="final-score">ფინალური ანგარიში: 5 - 3</div>
    <button class="restart-btn" onclick="restartGame()">თავიდან დაწყება</button>
  </div>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // iOS Touch Optimization
    document.addEventListener('touchstart', function(e) {
      if (e.touches.length > 1) {
        e.preventDefault();
      }
    }, { passive: false });

    document.addEventListener('touchmove', function(e) {
      if (e.scale !== 1) {
        e.preventDefault();
      }
    }, { passive: false });

    // Prevent context menu on long press
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });

    // Your existing JavaScript code with iOS improvements
    const game_field = document.getElementById('game_field');
    const goal = document.getElementById('goal');
    const ball = document.getElementById('ball');
    const success = document.getElementById('success');
    const failure = document.getElementById('failure');
    const svg = document.getElementById('svg');
    const path = document.getElementById('path');

    // Game state variables
    let playerScore = 0;
    let computerScore = 0;
    let playerPenalties = 0;
    let computerPenalties = 0;
    let isPlayerTurn = true;
    let gameActive = true;
    const maxPenalties = 5;
    let selectedGoalkeeperPosition = null;
    let isSuddenDeath = false;

    // Goalkeeper images - make sure these paths are correct
    const goalie = [
      'img/leftdown.png',    // Position 0 - Left down
      'img/leftup.png',      // Position 1 - Left up
      'img/centerup.png',    // Position 2 - Center up
      'img/rightup.png',     // Position 3 - Right up
      'img/rightdown.png'    // Position 4 - Right down
    ];

    // Rest of your existing JavaScript code...
    // [Include all your existing JavaScript code here]

    // Initialize game with iOS support
    function initGame() {
      // iOS-specific initialization
      if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
        document.body.style.height = '100vh';
        document.body.style.height = '-webkit-fill-available';
      }
      
      // Your existing init code
      initGameMeasurements();
      // preloadImages(goalie); // Make sure image paths work
      
      goal.addEventListener('click', grabClick);
      goal.addEventListener('touchstart', grabClick, { passive: false });
      goal.addEventListener('mousemove', handleMouseMove);
      
      updateUI();
      setHitboxesVisibility(true);
      updateTotalScore();
    }

    // Make sure to call init when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initGame);
    } else {
      initGame();
    }
  </script>
</body>
</html>